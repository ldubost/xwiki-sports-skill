<?xml version="1.0" encoding="UTF-8"?>

<xwikidoc version="1.3" reference="Sports.Code.Football" locale="">
  <web>Sports.Code</web>
  <name>Football</name>
  <language/>
  <defaultLanguage>en</defaultLanguage>
  <translation>0</translation>
  <creator>xwiki:XWiki.Admin</creator>
  <creationDate>1546297200000</creationDate>
  <parent>WebHome</parent>
  <author>xwiki:XWiki.Admin</author>
  <contentAuthor>xwiki:XWiki.Admin</contentAuthor>
  <date>1546297200000</date>
  <contentUpdateDate>1546297200000</contentUpdateDate>
  <version>1.1</version>
  <title>Football</title>
  <comment/>
  <minorEdit>false</minorEdit>
  <syntaxId>xwiki/2.1</syntaxId>
  <hidden>false</hidden>
  <content>// {{groovy}}
import groovy.json.JsonOutput;
import org.joda.time.format.DateTimeFormat;

public class Soccer {
  def xwiki;
  def xcontext;
  def request;
  def response;
  def sports;
  
  def addDebug(str) {
    sports.addDebug(str);
  }

  def setXWiki(xwiki, xcontext, sports) {
    this.xwiki = xwiki;
    this.xcontext = xcontext;
    this.request = xcontext.request;
    this.response = xcontext.response;
    this.sports = sports;
  }
  
  def saveTeam(player, playerSpace) {
      if (player!=null &amp;&amp; player.trim()!="") {
       def playerPageName = playerSpace + "." + player;
       addDebug("Ready to save team " + playerPageName)
       if (!xwiki.exists(playerPageName)) {
          addDebug("Saving team " + playerPageName)
          def playerDoc = xwiki.getDocument(playerPageName)
          playerDoc.use(playerDoc.getObject("Sports.Volley-Ball.Teams.Code.TeamsClass", true))
          playerDoc.setTitle(player);
          playerDoc.save("Creating team")
       }
        return playerPageName;
      }
      return null;
  }

  def saveResults(games, source) {
    /*
    def className = "Sports.Volley-Ball.Games.Code.GamesClass";
    for (g in games) {
      def player1PageName = saveTeam(g.player1, source.playerSpace)
      def player2PageName = saveTeam(g.player2, source.playerSpace)
      def winnerPageName = saveTeam(g.winner, source.playerSpace)
      addDebug("Ready to save game " + player1PageName + " " + player2PageName + " " + winnerPageName)
      if (player1PageName==null || player2PageName==null) {
        addDebug("No saving")
        continue;
      }
      def sid = "${source.competition}${source.year}${g.player1}${g.player2}"
      def id = sid.hashCode()
      if (id&lt;0) id=-id
      def gamePageName = "${source.gameSpace}.${id}";
      def sgamePageName = gamePageName.toString()
      def gameDoc = xwiki.getDocument(sgamePageName)
      if (gameDoc.isNew()||gameDoc.getObject(className)) {
          def needsSave = false;
          gameDoc.use(gameDoc.getObject(className, true))
          if (gameDoc.getValue("team1")!= player1PageName) {
             gameDoc.set("team1", player1PageName);
             addDebug("player1 changed")
             needsSave = true;
          }
          if (gameDoc.getValue("team2")!= player2PageName) {
             gameDoc.set("team2", player2PageName);
             addDebug("player2 changed")
             needsSave = true;
          }
          if (g.winner &amp;&amp; g.winner!="" &amp;&amp; gameDoc.getValue("winner")!= winnerPageName) {
             gameDoc.set("winner", winnerPageName);
             addDebug("winner changed")
             needsSave = true;
          }
          if (g.score &amp;&amp; g.score!="" &amp;&amp; gameDoc.getValue("score")!= g.score) {
             addDebug("score changed")
             gameDoc.set("score", g.score);
             needsSave = true;
          }
          if (g.detailedScore &amp;&amp; g.detailedScore!="" &amp;&amp; gameDoc.getValue("detailedScore")!= g.detailedScore) {
             addDebug("detailedScore changed")
             gameDoc.set("detailedScore", g.detailedScore);
             needsSave = true;
          }
        
          def df = DateTimeFormat.forPattern('yyyy dd MMM HH:mm').withLocale(new Locale("en"))
          def currentDate = gameDoc.display("gameDate")
          def sdate = source.year + " " + g.date + " " + g.time;
          gameDoc.set("gameDate", df.parseDateTime(sdate).toDate())
          def newDate = gameDoc.display("gameDate")
          if (g.date &amp;&amp; g.date!="" &amp;&amp; currentDate!=newDate) {
             addDebug("gameDate changed")
             needsSave = true;
          }
          if (gameDoc.getValue("competition")!= source.competition) {
             addDebug("competition changed")
             gameDoc.set("competition", source.competition);
             needsSave = true;
          }
          def currentYear = gameDoc.display("year")
          gameDoc.set("year", source.year);
          def newYear = gameDoc.display("year")
          if (currentYear!=newYear) {
             addDebug("year changed")
             needsSave = true;
          }
          if (needsSave) {
             addDebug("Saving game ${sgamePageName}")
             gameDoc.save("Creating game")
          }
       }
    }
    */
  }

  def cleanScore(score) {
    return score.replaceAll("\\u2013", " ");
  }
  
  def getResults(data, currentPlayer) {
    def cacheId = data.hashCode();
    def games = []

    if (sports.cache.get(cacheId)!=null &amp;&amp; !request.force) {
      addDebug("From cache");
      games = sports.cache.get(cacheId);
    } else {
      /*
      def m = data =~ /(?ms)\{\{Feuille de match.*? date = \{\{date\|(.*?\|.*?\|.*?\|).*?\| heure = (.*?)\|.*?.quipe 1 = .*?\{\{(.*?)\s.*?\| .quipe 2 = .*?\{\{(.*?)\s.*?\| score = ([0-9]*?)\s.*?\s([0-9]?).*?stade/
      addDebug("Found: " + m.count + " items");
       (0..&lt;m.count).each {
         def game = [:]
         game.date = m[it][1].replaceAll("\\|", " ").trim()
         game.time = m[it][2].trim()
         game.player1 = m[it][3].trim()
         game.player2 = m[it][4].trim()
         game.score = (m[it][5].trim()=="" &amp;&amp; m[it][6].trim()=="") ? "" : m[it][5].trim() + "-" + m[it][6].trim()
         def goal1 = (m[it][5].trim()=="") ? 0 : Integer.parseInt(m[it][5])
         def goal2 = (m[it][6].trim()=="") ? 0 : Integer.parseInt(m[it][6])
         if (goal1&gt;goal2)
            game.winner = game.player1
         if (goal2&gt;goal1)
            game.winner = game.player2
         games.add(game)
      }
      */
      
      
      /* Sample output 
      {{Feuille de match
| titre = Match 1
| date = {{date|7|juin|2019|en football}}
| heure = 21:00
| historique = 
| équipe 1 = '''{{FRA football féminin|d}}'''
| équipe 2 = {{KOR football féminin}}
| score = 4 - 0
| score mi-temps = 3 - 0
| buts 1 = ([[Amandine Henry|Henry]] {{passe décisive}}) [[Eugénie Le Sommer|Le Sommer]] {{but|9}} &lt;br&gt; ([[Gaëtane Thiney|Thiney]] {{passe décisive}}) [[Wendie Renard|Renard]] {{but|35}} &lt;br&gt; ([[Amel Majri|Majri]] {{passe décisive}}) [[Wendie Renard|Renard]] {{but|45+2}} &lt;br&gt; ([[Eugénie Le Sommer|Le Sommer]] {{passe décisive}}) [[Amandine Henry|Henry]] {{but|85}}
| buts 2 = 
| stade = [[Parc des Princes]], [[Paris]]
| affluence = {{formatnum:45261}}
| arbitre = {{URU-d}} [[Claudia Umpiérrez]]
| rapport = [https://fr.fifa.com/womensworldcup/matches/match/300438238/#undefined Rapport]
}}
*/
      def m = data =~ /(?ms)\{\{Feuille de match.*?\n(.*?)\n\}\}/
      addDebug("Found: " + m.count + " items");
       (0..&lt;m.count).each {
         def matchData = m[it][1];
         def matchMap = [:]
         def m2 = matchData =~ /\|(.*?)=(.*)/
         (0..&lt;m2.count).each {
            matchMap.put(m2[it][1].trim(), m2[it][2].trim())
         }        
         def game = [:]
         def p1m = (matchMap.get("\u00e9quipe 1") =~ /.*?\{\{(.*?)\s.*/)
         game.player1 = p1m.count&gt;0 ? p1m[0][1] : ""
         def p2m = (matchMap.get("\u00e9quipe 2") =~ /.*?\{\{(.*?)\s.*/)
         game.player2 = p2m.count&gt;0 ? p2m[0][1] : ""
         game.score = matchMap.get("score")
         def dm = (matchMap.get("date") =~ /\{\{date\|(.*?\|.*?\|.*?\|).*?/)
         game.date = (dm.count&gt;0) ? (dm[0][1].replaceAll("\\|", "/") + " " + matchMap.get("heure")) : ""
         def sm = game.score =~ /([0-9]*?)\s.*?\s([0-9]?)/
         def goal1 = (sm.count==0 || sm[0][1].trim()=="") ? 0 : Integer.parseInt(sm[0][1])
         def goal2 = (sm.count==0 || sm[0][2].trim()=="") ? 0 : Integer.parseInt(sm[0][2])
         if (goal1&gt;goal2)
            game.winner = game.player1
         if (goal2&gt;goal1)
            game.winner = game.player2
         games.add(game) 
         addDebug("Found: ${game}")
       }

      sports.cache.put(cacheId, games);
    }
    return games;
  }
}
// {{/groovy}}</content>
</xwikidoc>
